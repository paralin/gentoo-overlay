From 1bb47f8580efe7cf7726cb80796500a700659e7c Mon Sep 17 00:00:00 2001
From: Christian Stewart <christian@aperture.us>
Date: Wed, 2 Aug 2023 14:21:39 -0700
Subject: [PATCH] test-bitcode-dir

Signed-off-by: Christian Stewart <christian@aperture.us>
---
 test/compile/CMakeLists.txt            | 1 +
 test/compile/RunConstantFoldTest.cmake | 1 +
 2 files changed, 2 insertions(+)

diff --git a/test/compile/CMakeLists.txt b/test/compile/CMakeLists.txt
index 9af0b1a..7b76296 100644
--- a/test/compile/CMakeLists.txt
+++ b/test/compile/CMakeLists.txt
@@ -30,6 +30,7 @@ function(add_compile_test test_name func_name script test_cpu extra_check_prefix
      -DFILECHECK_BIN=${FILECHECK_BIN}
      -DOUTPUT_FILE=output.${name}.${test_cpu}.s
      -DINPUT_FILE=${CMAKE_CURRENT_SOURCE_DIR}/${func_name}.cl
+     -DAMDGCN_BITCODES=${PROJECT_BINARY_DIR}/lib/amdgcn/bitcode
      -DTEST_CPU=${test_cpu}
      -DEXTRA_CHECK_PREFIX=${extra_check_prefixes}
      -P ${script})
diff --git a/test/compile/RunConstantFoldTest.cmake b/test/compile/RunConstantFoldTest.cmake
index 5424690..1d4241a 100644
--- a/test/compile/RunConstantFoldTest.cmake
+++ b/test/compile/RunConstantFoldTest.cmake
@@ -16,6 +16,7 @@ execute_process(COMMAND
   -target amdgcn-amd-amdhsa -mcpu=${TEST_CPU}
   -Xclang -finclude-default-header
   --rocm-path=${BINARY_DIR}
+  --rocm-device-lib-path=${AMDGCN_BITCODES}
   -mllvm -amdgpu-simplify-libcall=0
   -o ${OUTPUT_FILE} ${INPUT_FILE}
   RESULT_VARIABLE CLANG_RESULT
-- 
2.41.0

